# Goal
Detect when a query from the osquery osx-attacks query pack detects a positive hit on malware/adware on MacOS endpoints.

# Categorization
These attempts are categorized as one of several MITRE ATT&CK categorizes: 

* [Persistence / Launch Agent](https://attack.mitre.org/wiki/Technique/T1159)
* [Persistence / Launch Daemon](https://attack.mitre.org/wiki/Technique/T1160)
* [Persistence / Login Item](https://attack.mitre.org/wiki/Technique/T1162)
* [Persistence / Logon Scripts](https://attack.mitre.org/wiki/Technique/T1037)
* [Persistence / Startup Items](https://attack.mitre.org/wiki/Technique/T1165)

# Strategy Abstract
The strategy will function as follows:

* Periodically run the osquery osx-attacks query pack on all MacOS endpoints.
* Alert on any hits on the osx-attacks query pack.

# Technical Context
The [osquery OSS project](https://osquery.io/) maintains a series of queries called "packs". One such pack is called the [osx-attacks pack](https://github.com/facebook/osquery/blob/master/packs/osx-attacks.conf) and it contains simple signatures to detect the presence of known adware and malware on OSX systems. This does not use any heuristics, it just looks for known indicators (usually plists) to indicate a positive infection. 

A sample osquery event looks like the following:
```
{  
    action: added  
    calendarTime:   Mon Sep  4 18:14:39 2017 UTC   
    columns:    {  
        disabled:  
        groupname: 
        inetd_compatibility:   
        keep_alive: 1  
        label:  com.spigot.ApplicationManager  
        name:   com.spigot.ApplicationManager.plist
        on_demand: 
        path:   /Users/tester/Library/LaunchAgents/com.spigot.ApplicationManager.plist  
        process_type:  
        program:   
        program_arguments:  /Users/tester/Library/Application Support/Spigot/ApplicationManager --protect   
        queue_directories: 
        root_directory:
        run_at_load:    1  
        start_interval:
        start_on_mount:
        stderr_path:   
        stdout_path:   
        username:  
        watch_paths:   
        working_directory: 
    }  
    decorations:    {   [+]
    }  
    hostIdentifier: testermac
    name:   pack/osx-attacks/Spigot
    unixTime:   1504548879 
}
```

# Blind Spots and Assumptions
This strategy relies on the following assumptions:
* Osquery is running on hosts.
* Osquery has the correct query packs. 
* Osquery is successfully reporting data to the Kolide endpoint. 
 
A blind spot will occur if any of the assumptions are violated. For instance, the following would not trip the alert:
* Osquery stops running or is tampered with. 
* The malware sample does not match an entry in the osx-attacks query pack.

Note: This detection method is only able to detect known malware using static indicators. Malware variants may not be picked up by osquery.

# False Positives
There are very limited instances where false positives will occur:
* A legitimate file uses the same filename or filepath as a malicious sample.
* A legitimate file is accidentally added to the osx-attacks query pack.

Note: No false positives were detected during staging or production. It is extremely unlikely that a false positive will occur on this ADS. 

# Priority
The priority is set to high under all conditions.

# Validation
Validation can occur for this ADS by performing the following execution on a MacOS host:

```
echo '<?xml version="1.0" encoding="UTF-8"?>
> <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
> <plist version="1.0">
> <dict>
>     <key>KeepAlive</key>
>     <dict>
>         <key>SuccessfulExit</key>
>         <false/>
>     </dict>
>     <key>Label</key>
>     <string>com.apple.xpcd.plist</string>
>     <key>LimitLoadToSessionType</key>
>     <string>Aqua</string>
>     <key>ProgramArguments</key>
>     <array>
>         <string>id</string>
>        </array>
>     <key>RunAtLoad</key>
>     <true/>
> </dict>
> </plist>' > ~/Library/LaunchAgents/com.apple.xpcd.plist
 
launchctl load ~/Library/LaunchAgents/com.apple.xpcd.plist
```
This validation scenario will create a PLIST file which should trigger a detection for OSX_Proton. 

# Response
In the event that this alert fires, the following response procedures are recommended:
* Identify the signature that was used to create the alert. This should fall into one of two buckets: commodity or sophisticated. 
  * Commodity includes adware, PUPs, and other unwanted software.
  * Sophisticated includes any implant which was used in a CNE campaign. 
* If the signature relates to a commodity implant, perform the following:
  * Follow the MacOS anti-adware playbook and ensure implant removal.
  * Perform blocking on any C2 infrastructure. 
* If the signature relates to a sophisticated implant, perform the following:
  * Escalate to a security incident.

# Additional Resources
* [Osquery osx-attacks pack](https://github.com/facebook/osquery/packs/osx-attacks.conf)